pipeline {
    agent any

    environment {
        IMAGE_TAG = "${BUILD_NUMBER}"
    }

    stages {

        // 1. Checkout application source code
        stage('Checkout App Repo') {
            steps {
                git credentialsId: 'GitHub-Creds',
                    url: 'https://github.com/rameshjavali/Jenkins-Zero-To-Hero.git',
                    branch: 'main'
            }
        }

        // 2. Build and push Docker image
        stage('Build & Push Docker Image') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh """
                        echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
                        docker build -t $DOCKER_USER/todoapp:${BUILD_NUMBER} -f python-jenkins-argocd-k8s/Dockerfile python-jenkins-argocd-k8s/
                        docker push $DOCKER_USER/todoapp:${BUILD_NUMBER}
                        """
                    }
                }
            }
        }

        // 3. Checkout Kubernetes manifests repo
        stage('Checkout Manifests Repo') {
            steps {
                git credentialsId: 'GitHub-Creds',
                    url: 'https://github.com/rameshjavali/todoapp-manifests.git',
                    branch: 'main'
            }
        }

        // 4. Update deployment.yaml with new image tag and push back
        stage('Update Manifest & Push') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'GitHub-Creds', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
                        sh """
                        sed -i "s|image: .*|image: $DOCKER_USER/todoapp:${BUILD_NUMBER}|g" deploy.yaml
                        git config user.email "jenkins@ci.local"
                        git config user.name "Jenkins CI"
                        git add deploy.yaml
                        git commit -m "Update image tag to ${BUILD_NUMBER}"
                        git push https://${GIT_USER}:${GIT_PASS}@github.com/rameshjavali/todoapp-manifests.git HEAD:main
                        """
                    }
                }
            }
        }
    }
}
